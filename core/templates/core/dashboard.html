{% extends 'core/base.html' %}
{% load static %}

{% block title %}Dashboard - FinanceHub{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Low Cash Warning -->
    {% if profile.money_on_hand < 100 %}
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Low Balance Warning:</strong> Your cash on hand is below ₱100.00. Consider adding more funds.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <!-- Welcome Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="mb-1">
                                <i class="fas fa-sun text-warning me-2"></i>
                                Welcome back, {{ user.first_name|default:user.username }}!
                            </h2>
                            <p class="text-muted mb-0">Here's your financial summary for {{ current_month }}</p>
                        </div>
                        <div class="text-end">
                            <a href="{% url 'core:weekly_report' %}" class="btn btn-outline-primary btn-sm me-2">
                                <i class="fas fa-calendar-week me-1"></i>Weekly
                            </a>
                            <a href="{% url 'core:monthly_report' %}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-calendar-alt me-1"></i>Monthly
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Expense Entry -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="quick-expense-card">
                <h5 class="mb-3">
                    <i class="fas fa-bolt text-warning me-2"></i>Quick Expense Entry
                </h5>
                <form id="quickExpenseForm" class="row g-3 align-items-end" data-cash-on-hand="{{ profile.money_on_hand }}">
                    {% csrf_token %}
                    <div class="col-md-3">
                        <label class="form-label">Amount (₱)</label>
                        {{ quick_form.amount }}
                        <small class="form-text text-muted">Max: ₱{{ profile.money_on_hand|floatformat:2 }}</small>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Category</label>
                        {{ quick_form.category }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Description (Optional)</label>
                        {{ quick_form.description }}
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-danger w-100">
                            <i class="fas fa-plus me-1"></i>Add Expense
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Key Financial Metrics -->
    <div class="row g-3 mb-4">
        <!-- Cash on Hand -->
        <div class="col-lg-3 col-md-6">
            <div class="card stat-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="flex-grow-1">
                            <p class="stat-label mb-2">Cash on Hand</p>
                            <h3 class="stat-value text-success mb-0" id="cashOnHandValue">₱{{ profile.money_on_hand|floatformat:2 }}</h3>
                            <small class="text-muted">Available Balance</small>
                        </div>
                        <i class="fas fa-wallet stat-icon text-success"></i>
                    </div>
                    <button type="button" class="btn btn-outline-success btn-sm w-100 mt-2" data-bs-toggle="modal" data-bs-target="#addCashModal">
                        <i class="fas fa-plus me-1"></i>Add Cash
                    </button>
                </div>
            </div>
        </div>

        <!-- Monthly Income -->
        <div class="col-lg-3 col-md-6">
            <div class="card stat-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <p class="stat-label mb-2">Monthly Income</p>
                            <h3 class="stat-value text-primary mb-0">₱{{ monthly_income|floatformat:2 }}</h3>
                            <small class="text-muted">This Month</small>
                        </div>
                        <i class="fas fa-arrow-trend-up stat-icon text-primary"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monthly Expenses -->
        <div class="col-lg-3 col-md-6">
            <div class="card stat-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <p class="stat-label mb-2">Monthly Expenses</p>
                            <h3 class="stat-value text-danger mb-0" id="monthlyExpensesValue">₱{{ monthly_expenses|floatformat:2 }}</h3>
                            <small class="text-muted">This Month</small>
                        </div>
                        <i class="fas fa-arrow-trend-down stat-icon text-danger"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Savings -->
        <div class="col-lg-3 col-md-6">
            <div class="card stat-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <p class="stat-label mb-2">Total Savings</p>
                            <h3 class="stat-value text-info mb-0">₱{{ total_savings|floatformat:2 }}</h3>
                            <small class="text-muted">All Time</small>
                        </div>
                        <i class="fas fa-piggy-bank stat-icon text-info"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="row g-4">
        <!-- Left Column: Charts -->
        <div class="col-lg-8">
            <!-- Expense Breakdown Chart -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Expense Breakdown by Category
                    </h5>
                </div>
                <div class="card-body">
                    {% if category_expenses %}
                        <div class="chart-container">
                            <canvas id="expensePieChart"></canvas>
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-chart-pie"></i>
                            <p>No expenses recorded this month</p>
                            <small>Start tracking your expenses to see insights</small>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Spending Trend -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>6-Month Spending Trend
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="trendLineChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Lists -->
        <div class="col-lg-4">
            <!-- Active Budgets -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-bullseye me-2"></i>Active Budgets
                    </h5>
                </div>
                <div class="card-body">
                    {% if budget_overview %}
                        {% for item in budget_overview %}
                        <div class="budget-item">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">{{ item.budget.name }}</h6>
                                <span class="badge bg-primary">{{ item.budget.budget_type|title }}</span>
                            </div>
                            <div class="progress mb-2">
                                <div class="progress-bar {% if item.percentage > 90 %}bg-danger{% elif item.percentage > 75 %}bg-warning{% else %}bg-success{% endif %}" 
                                     style="width: {{ item.percentage }}%">
                                </div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">₱{{ item.spent|floatformat:2 }} / ₱{{ item.budget.amount|floatformat:2 }}</small>
                                <small class="{% if item.remaining < 0 %}text-danger{% else %}text-success{% endif %}">
                                    ₱{{ item.remaining|floatformat:2 }} left
                                </small>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-bullseye"></i>
                            <p>No active budgets</p>
                            <a href="{% url 'core:weekly_report' %}" class="btn btn-outline-primary btn-sm">Create Budget</a>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Recent Transactions -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-receipt me-2"></i>Recent Transactions
                    </h5>
                    <a href="{% url 'core:transaction_list' %}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-list me-1"></i>View All
                    </a>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;" id="recentTransactionsList">
                    {% if recent_transactions %}
                        {% for transaction in recent_transactions %}
                        <div class="transaction-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="d-flex align-items-start flex-grow-1">
                                    <div class="me-3 mt-1">
                                        {% if transaction.transaction_type == 'income' %}
                                            <i class="fas fa-arrow-up text-success fa-lg"></i>
                                        {% elif transaction.transaction_type == 'expense' %}
                                            <i class="fas fa-arrow-down text-danger fa-lg"></i>
                                        {% else %}
                                            <i class="fas fa-piggy-bank text-info fa-lg"></i>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <h6 class="mb-1">{{ transaction.title }}</h6>
                                        <small class="text-muted">
                                            <span class="category-badge" style="background: {{ transaction.category.color }}"></span>
                                            {{ transaction.category.name }} • {{ transaction.date|date:"M d, Y" }}
                                        </small>
                                    </div>
                                </div>
                                <div class="text-end ms-2">
                                    <strong class="{% if transaction.transaction_type == 'income' %}amount-positive{% elif transaction.transaction_type == 'expense' %}amount-negative{% else %}text-info{% endif %}">
                                        {% if transaction.transaction_type == 'income' %}+{% elif transaction.transaction_type == 'expense' %}-{% endif %}₱{{ transaction.amount|floatformat:2 }}
                                    </strong>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-receipt"></i>
                            <p>No transactions yet</p>
                            <small>Use quick expense entry above to start tracking</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Cash Modal -->
<div class="modal fade" id="addCashModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="background: var(--card-bg); border: 2px solid var(--primary-violet);">
            <div class="modal-header" style="border-bottom-color: var(--border-color);">
                <h5 class="modal-title">
                    <i class="fas fa-wallet me-2 text-success"></i>Add Cash on Hand
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'core:add_cash_on_hand' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Amount (₱)</label>
                        {{ add_cash_form.amount }}
                        <small class="form-text text-muted">Enter the amount you want to add to your balance</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description (Optional)</label>
                        {{ add_cash_form.description }}
                    </div>
                </div>
                <div class="modal-footer" style="border-top-color: var(--border-color);">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-plus me-1"></i>Add Cash
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Alert Container for Top-Right Notifications -->
<div id="alertContainer" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;"></div>
{% endblock %}

{% block extra_js %}
<script>
// Pass Django data to JavaScript
window.dashboardData = {
    chartData: {{ chart_data|safe }},
    monthlyTrend: {{ monthly_trend|safe }},
    hasCategoryExpenses: {% if category_expenses %}true{% else %}false{% endif %},
    cashOnHand: {{ profile.money_on_hand }},
    monthlyExpenses: {{ monthly_expenses }}
};
</script>
<script src="{% static 'js/dashboard.js' %}"></script>
{% endblock %}